# ğŸ›‘ Common Mistakes & Pre-Flight Checklist (ç»éªŒå¤ç›˜ä¸é¿å‘æŒ‡å—)

> **Purpose:** actively track past implementation errors to prevent recurrence. 
> **Usage:** Review this document BEFORE applying complex logic changes or refactoring.

## 1. âš ï¸ Logic & Control Flow Errors (é€»è¾‘æ§åˆ¶é”™è¯¯)

### [Critical] Empty/Duplicate Logic Blocks (ç©ºé€»è¾‘å—é®è”½)
*   **Incident:** `Workbench.jsx` Header Logic Refactor (2026-02-04)
*   **Problem:** An empty `else if (condition) {}` block was left above the *real* logic block. The empty block captured the condition, causing the real code to be unreachable.
*   **Prevention Rule:** 
    *   **NEVER** leave empty `if/else` blocks "for future use".
    *   **ALWAYS** verify the *structure* of the code surrounding the edit target, not just the lines being replaced.
    *   **USE** `view_file` to inspect the full context if `multi_replace` fails or behavior is unexpected.

### [High] Variable Shadowing (å˜é‡é®è”½)
*   **Incident:** `Workbench.jsx` Header Logic Refactor (2026-02-04)
*   **Problem:** Redeclared `titleMap` inside a second `if` block within the same scope (or effectively confusing the scope), causing TypeScript errors and logic ambiguity.
*   **Prevention Rule:** 
    *   **Use Specific Names**: Instead of generic `titleMap`, use `projectTitleMap`, `businessTitleMap`, `entTitleMap`.
    *   **Check Scope**: Be aware of variables declared in the upper scope of the function/hook.

### [Medium] Import Path Errors (å¼•ç”¨è·¯å¾„é”™è¯¯)
*   **Incident:** `CreateProjectPage.jsx` HeaderContext Import (2026-02-04)
*   **Problem:** Used `../../context` instead of `../../../context` when moving between component depths.
*   **Prevention Rule:**
    *   **Double-Check Depths**: When creating files in deep L2/L3 directories, explicitly count the `../` required to reach the root `src`.

## 2. ğŸ§  Business Logic Misalignments (ä¸šåŠ¡é€»è¾‘åå·®)

### [High] Context vs. Label Mismatch (è¯­å¢ƒé”™ä½)
*   **Incident:** L1 Header Titles (2026-02-04)
*   **Problem:** Displaying the "Room Name" (e.g., "Project Management") instead of the "Activity Name" (e.g., "All Projects").
*   **Prevention Rule:**
    *   **The "Context Rule"**: The Page Header must answer "What am I doing right now?", not "Where is this link located?".
    *   **Default States**: Ensure the Default State (entering a module) matches the Default Content Title.

### [High] Header Definition Conflicts (å¯¼èˆªæ å±‚çº§å†²çª)
*   **Incident:** Double Headers in `DoubleColumnPage` (2026-02-04)
*   **Problem:** The system global header (`Header.jsx`) and the page-internal headers (`LeftHeader/RightHeader`) appeared simultaneously.
*   **Prevention Rule:**
    *   **Architecture Solution**: Use Context (e.g., `HeaderContext`) to control global header visibility.
    *   **Exclusive Mode**: When a specific page layout (like a Creation Wizard) needs to control the full viewport top-to-bottom, it must explicitly suppress the global system header.

## 3. ğŸ—ï¸ Architecture & Documentation (æ¶æ„ä¸æ–‡æ¡£)

### [Critical] Authority of Documentation (æ–‡æ¡£è£åˆ¤æƒ)
*   **Lesson:** `PROJECT_RULES.md` is the Constitution; `design_system.md` is the Law.
*   **Rule:** **Never redefine rules.** If a style in `design_system` conflicts with a principle in `PROJECT_RULES`, `PROJECT_RULES` wins. Do not "invent" new rules in code to patch conflicts.

### [High] Layout Consistency (å¸ƒå±€ç»Ÿä¸€æ€§)
*   **Incident:** Enterprise Detail View Layout Mismatch.
*   **Lesson:** Do not build "Special Layouts" for specific entities (e.g., Enterprise).
*   **Rule:** **Reuse Standard Layouts.** All Detail Views (Tabs) MUST use the standard `ProjectLayout` structure (Sidebar + Content). Inject content via Context/Props, do not rebuild the frame.

### [High] The "Card vs Canvas" Trap (å¡ç‰‡ä¸ç”»å¸ƒè¯¯åŒº)
*   **Incident:** `DoubleColumnPage` Visual Style (2026-02-04)
*   **Lesson:** Treating layouts as "Floating Cards" (with gaps, shadows, rounded corners) when the user expects a "Unified Workspace" (Full width, shared borders).
*   **Rule:** **Canvas First.** For primary workspaces, prefer full-height, zero-margin layouts that use dividers (`border-right`) rather than gaps to separate content.

## 4. ğŸ’» Code Quality & Patterns (ä»£ç è´¨é‡ä¸æ¨¡å¼)

### [High] Refactor > Copy-Paste (ç»„ä»¶å¤ç”¨åŸåˆ™)
*   **Incident:** `BusinessSidebar` vs `L2Sidebar` (2026-02-04).
*   **Lesson:** Creating "Twin Components" for similar views leads to double maintenance (e.g., fixing collapse logic twice).
*   **Rule:** **Extend, Don't Duplicate.** If a component is 80% similar, add a `mode` or `config` prop to handle the 20% difference.

## 5. ğŸ¨ UI/UX Precision (äº¤äº’ç²¾ç¡®æ€§)

### [Medium] Visual State Precision (è§†è§‰çŠ¶æ€å…¨é›†)
*   **Incident:** Checkbox Checked+Disabled State.
*   **Lesson:** UI is not just "Enabled/Disabled". Business logic often requires "Mandatory Active" (Checked + Disabled).
*   **Rule:** **Enumerate States.** Implement the full matrix of states (Checked/Unchecked x Enabled/Disabled) from the start.

### [High] Functional Context First (åŠŸèƒ½è¯­å¢ƒä¼˜å…ˆ)
*   **Incident:** Header Title Mismatch (Project Tag vs All Projects).
*   **Lesson:** Users care about "What I am doing" (Activity), not "Where I am" (Room).
*   **Rule:** **Header = Activity.** The Page Header must always match the *default inner content* title. (e.g., Entering "Project Mgmt" -> Header must be "All Projects", NOT "Project Management").

### [Medium] Semantic Icons & Typography (è¯­ä¹‰åŒ–è§†è§‰)
*   **Incident:** Close vs Exit Icon; Header Title format (2026-02-04)
*   **Lesson:** "Close" (X) implies a temporary modal; "Exit/Logout" implies leaving a major workflow.
*   **Rule:**
    *   **Contextual Icons:** Use icons that match the *magnitude* of the action (e.g., `IconLogout` for leaving a wizard).
    *   **Structured Titles:** Break titles into `Topic` + `Operation` (e.g., "Project" + "Create") to clarify hierarchy.

### [Critical] Interaction Consistency Violation (äº¤äº’ä¸€è‡´æ€§ç ´å)
*   **Incident:** Custom Inputs in Create Research Object Page (2026-02-04)
*   **Problem:** Developer attempted to use raw `<TextInput>` components to create an "always open" form, violating the project standard of using `<EditableField>` for all key-value entries.
*   **Lesson:** Consistency > Local Optimization. Even if "fewer clicks" feels better locally, breaking the visual pattern makes the app feel "patchy" and unprofessional.
*   **Prevention Rule:**
    *   **Strict Component Adherence**: If a standard component (like `EditableField`) exists, use it via its API (props). Do not bypass it by injecting custom children unless documented as a valid pattern.
    *   **Verify Patterns**: Before building a form, check `interaction_patterns.md`. If the pattern ("Open Form") isn't there, don't invent it.

## 6. ğŸ› ï¸ Tooling & Verification (å·¥å…·ä¸éªŒè¯)

### [Medium] Verification Laziness (éªŒè¯æƒ°æ€§)
*   **Incident:** Premature confirmation of fixes.
*   **Problem:** Assuming a fix worked because the tool call didn't error, without verifying the *runtime logic* path.
*   **Prevention Rule:**
    *   **Trace the Path**: mentally walk through: "If input is X, does it hit Block A or Block B?".
    *   **Full File Read**: After a messy series of edits, perform one full `view_file` to ensure structural integrity.

---

## ğŸš€ Pre-Flight Checklist (Before Complex Edits)

1.  [ ] **Context Check**: Do I see the 10 lines *before* and *after* my target edit?
2.  [ ] **Shadow Check**: Am I reusing a variable name (`config`, `map`, `data`) that already exists?
3.  [ ] **Logic Check**: Did I delete the old logic block, or did I just append new logic *after* it?
4.  [ ] **User Rule Check**: Does this change violate a "Fixed Rule" (e.g., Header = Context)?
5.  [ ] **Visual Check**: Does the code imply "Card" (m-4, rounded) when "Canvas" (h-full, border-r) is needed?
6.  [ ] **Pattern Check**: Am I inventing a new interaction style? Check `interaction_patterns.md` first.

## 7. ğŸš¨ State & Interaction Patterns (çŠ¶æ€ä¸äº¤äº’)

### [Critical] Unstable Persistence (çŠ¶æ€ä¸¢å¤±)
*   **Incident:** Project List Persistence (2026-02-04)
*   **Problem:** Stored critical data (Project List) in a localized component (`BusinessContent`) that unmounted during navigation (view switching), causing data loss.
*   **Prevention Rule:**
    *   **Lift State Up**: Data that must survive view transitions (like "All Projects") MUST be held in the Root Component (`App.jsx`) or a global Context.
    *   **Lifecycle Awareness**: Always ask "Will this component unmount?" when defining state.

### [High] Usability Friction (äº¤äº’é˜»æ‘©æ“¦)
*   **Incident:** `EditableField` Click-to-Edit (2026-02-04)
*   **Problem:** Form fields required clicking a specific small Icon/Button to edit, which is confusing in a "Wizard/Creation" context where the primary goal is input.
*   **Prevention Rule:**
    *   **Contextual Interaction**: In a "Read-Only Details" view, click-to-edit icons are fine (safety). In a "Creation Form", the **entire field area** must be clickable or open by default.
    *   **Defensive Feedback**: If validation prevents action (e.g., button disabled), provide explicit feedback (Alerts/Toasts) or keep button enabled but intercept click, rather than failing silently.

## 8. ğŸ“‰ Execution Precision (æ‰§è¡Œç²¾åº¦)

### [Critical] Code Modification Blindness (ä»£ç ä¿®æ”¹ç›²åŒº)
*   **Incident:** Syntax Errors in `Workbench.jsx` & `CreateProjectPage.jsx` (2026-02-04)
*   **Problem:** Introduced multiple syntax errors (double braces, duplicated arguments, duplicated function blocks) during `replace_file_content` operations. This happened because of copying large chunks without verifying the boundaries of the replacement target.
*   **Prevention Rule:**
    *   **Precise Targeting**: Prefer replacing *smaller, distinct* blocks over huge chunks.
    *   **Boundary verification**: When replacing a function signature, verify if the closing `})` is included in the `TargetContent`.
    *   **Wait & Validate**: After a fix, *assume it is broken* until verified. Don't rush to notify the user.

### [Critical] State Management Scope (çŠ¶æ€ç®¡ç†ä½œç”¨åŸŸ)
*   **Incident:** Research Object Persistence (2026-02-04)
*   **Problem:** Created data (Research Objects) disappeared after navigation. The state was stored in `BusinessContent`, which unmounts when tabs change.
*   **Lesson:** "Creation" implies "Persistence". Any data that "feels" like it belongs to the database (Projects, Orders, Objects) must live at the App Root or Global Store, never in a view component.
*   **Prevention Rule:**
    *   **The "Database Test"**: Ask "If I close this view and come back, should the data still be there?". If YES, the state belongs in `App.jsx` or Context.

### [Medium] Visual Interpretation (è§†è§‰ç¿»è¯‘è¯¯åŒº)
*   **Incident:** Header Title Coloring (2026-02-04)
*   **Problem:** Developer interpreted "Active/Effective Title" as "Highlight Color" (Teal), but User meant "Valid Content" (Neutral/Professional).
*   **Lesson:** "Highlighting" != "Bright Colors". For core text content, "Highlight" often just means "Standard Opacity/Weight" vs "Dimmed".
*   **Rule:** **Neutral by Default.** Unless explicit (e.g., "Error Red", "Success Green"), text should be Neutral Gray (`text-gray-800`). Avoid using Brand Colors for data content unless it's a clickable link or specific status.
